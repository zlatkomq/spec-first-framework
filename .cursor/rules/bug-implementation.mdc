---
description: Rules for implementing bugfixes from BUG.md
globs: src/**/*
alwaysApply: false
---

# Bug Implementation Rules

You are implementing a bugfix based on an approved BUG.md. Follow these rules strictly.

## Required Inputs

Before implementing, you must have:
- Specific task from approved BUG.md (e.g., "Implement T1")
- Access to @bugs/BUG-XXX/BUG.md for bug details
- Access to the original @specs/XXX/SPEC.md (linked in BUG.md)
- Access to the original @specs/XXX/DESIGN.md for architecture context
- Access to @.framework/CONSTITUTION.md for coding standards

If BUG.md is not approved (Status != CONFIRMED), STOP and inform the user.

## Scope Control

### Minimal Change Principle
- Fix ONLY what is broken - nothing more
- Do NOT "improve" or refactor adjacent code
- Do NOT add features while fixing the bug
- Do NOT change behavior beyond what's needed for the fix

### What You CAN Change
- The specific code causing the bug
- Related code strictly necessary for the fix
- Test files (adding regression test)

### What You CANNOT Change
- Unrelated files or functions
- API contracts (unless the bug is in the contract itself)
- Database schemas (unless explicitly in the bug scope)
- Dependencies (unless strictly required for the fix)

## Regression Test Requirement

Every bugfix MUST include a regression test. This is mandatory, not optional.

### Regression Test Requirements
1. Test must be named to reference the bug: `test_bug_XXX_description` or similar
2. Test must reproduce the original bug scenario
3. Test must FAIL before the fix is applied (verify this mentally or explain)
4. Test must PASS after the fix is applied
5. Test must be placed in appropriate test directory per CONSTITUTION.md

### Test Structure
```
# Example structure (adapt to project conventions)
def test_bug_001_safari_validation_fails():
    """
    Regression test for BUG-001: Safari validation fails
    
    Reproduction: [brief description of scenario]
    Related spec: FEAT-001
    """
    # Arrange: Set up the bug scenario
    # Act: Perform the action that triggered the bug
    # Assert: Verify correct behavior
```

## Implementation Process

### For Investigation/Fix Tasks (T1)

1. **Locate the bug**
   - Follow the reproduction steps from BUG.md
   - Identify the exact file and function causing the issue
   - Update the "Root Cause Analysis" section in BUG.md with findings

2. **Implement the fix**
   - Make the minimal change needed
   - Follow CONSTITUTION.md coding standards
   - Ensure the fix aligns with DESIGN.md architecture

3. **Verify locally**
   - Confirm reproduction steps no longer produce the bug
   - Ensure existing tests still pass

### For Regression Test Tasks (T2)

1. **Create the test**
   - Name it to reference the bug ID
   - Include a docstring explaining what bug this prevents
   - Cover the exact reproduction scenario

2. **Verify the test**
   - Confirm the test passes with the fix in place
   - Explain why it would have failed before the fix

## Standards Compliance

### From CONSTITUTION.md
- Follow all coding standards (naming, structure, patterns)
- Use specified tech stack and libraries
- Follow file/folder structure conventions
- Apply error handling patterns

### From DESIGN.md
- Respect the existing architecture
- Do not introduce new patterns not in the design
- Maintain component boundaries

## Output

After implementing each task, provide:

```
## Bug Fix Summary

**Bug:** BUG-XXX - [description]
**Task:** [Task ID and description]

**Root Cause:**
- [Brief explanation of why the bug occurred]

**Fix Applied:**
- [What was changed and why]

**Files Changed:**
- path/to/file.py (modified) - [what changed]
- path/to/file.py (modified) - [what changed]

**Regression Test:**
- path/to/test_file.py (test_bug_XXX_description)
- Test verifies: [what the test checks]

**Verification:**
- [ ] Reproduction steps no longer produce bug
- [ ] Original acceptance criteria passes
- [ ] Regression test passes
- [ ] Existing tests still pass

**Notes:**
- [Any assumptions or decisions made, or "None"]
```

## Constraints

- Do NOT implement without an approved BUG.md
- Do NOT skip the regression test
- Do NOT make changes beyond the bug scope
- Do NOT modify the original SPEC.md or DESIGN.md
- Do NOT approve your own changes - that's for bug-review.mdc

## Checklist Before Done

- [ ] BUG.md status is CONFIRMED (approved)
- [ ] Only the specified task is implemented
- [ ] Fix is minimal and focused
- [ ] Root cause is documented in BUG.md
- [ ] Regression test is added and named appropriately
- [ ] Existing tests still pass
- [ ] Code follows CONSTITUTION.md standards
- [ ] Implementation summary is provided
