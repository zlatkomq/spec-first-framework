flowchart TD
    subgraph STEP0["STEP 0: Project Setup (Once)"]
        S0{Project Type?}
        
        subgraph GREENFIELD["GREENFIELD"]
            G1[Tech Lead creates CONSTITUTION.md<br/>Defines tech stack, standards, rules]
        end
        
        subgraph LEGACY["LEGACY / BROWNFIELD"]
            L1[Tech Lead analyzes existing codebase<br/>Documents current patterns, tech debt, constraints]
            L2[Tech Lead creates CONSTITUTION.md<br/>Includes: existing patterns, what NOT to touch,<br/>migration strategy, legacy boundaries]
        end
        
        S0 -->|New project| G1
        S0 -->|Existing codebase| L1
        L1 --> L2
    end

    subgraph STEP1["STEP 1: Create Specification"]
        S1A[PO provides requirements to Developer]
        S1B["Developer prompts AI:<br/><i>'Create SPEC.md for 001 password reset'</i>"]
        S1C["AI reads:<br/>â€¢ spec-creation.mdc (rules)<br/>â€¢ SPEC.template.md (structure)<br/>â€¢ CONSTITUTION.md (context)"]
        S1D[AI generates SPEC.md]
        S1E{Gate 1<br/>PO approves?}
        
        S1A --> S1B --> S1C --> S1D --> S1E
        S1E -->|No| S1B
    end

    subgraph STEP2["STEP 2: Create Technical Design"]
        S2A["Developer prompts AI:<br/><i>'Create DESIGN.md based on @SPEC.md'</i>"]
        S2B["AI reads:<br/>â€¢ design-creation.mdc (rules)<br/>â€¢ DESIGN.template.md (structure)<br/>â€¢ SPEC.md (input)<br/>â€¢ CONSTITUTION.md (context)"]
        S2C[AI generates DESIGN.md]
        S2D{Gate 2<br/>Tech Lead approves?}
        
        S2A --> S2B --> S2C --> S2D
        S2D -->|No| S2A
    end

    subgraph STEP3["STEP 3: Create Task Breakdown"]
        S3A["Developer prompts AI:<br/><i>'Create TASKS.md based on @DESIGN.md'</i>"]
        S3B["AI reads:<br/>â€¢ task-creation.mdc (rules)<br/>â€¢ TASKS.template.md (structure)<br/>â€¢ DESIGN.md (input)<br/>â€¢ CONSTITUTION.md (context)"]
        S3C[AI generates TASKS.md]
        S3D{Gate 3<br/>Tech Lead approves?}
        
        S3A --> S3B --> S3C --> S3D
        S3D -->|No| S3A
    end

    subgraph STEP4["STEP 4: Implement Code"]
        S4A["Developer prompts AI:<br/><i>'Implement task T1 from @TASKS.md'</i>"]
        S4B["AI reads:<br/>â€¢ implementation.mdc (rules)<br/>â€¢ TASKS.md (what to do)<br/>â€¢ DESIGN.md (how to do it)<br/>â€¢ CONSTITUTION.md (standards)"]
        S4C[AI generates code]
        S4D[Repeat for each task T2, T3...]
        
        S4A --> S4B --> S4C --> S4D
        S4D -->|next task| S4A
    end

    subgraph STEP5["STEP 5: Code Review"]
        S5A["Developer prompts AI:<br/><i>'Review code against @SPEC.md acceptance criteria'</i>"]
        S5B["AI reads:<br/>â€¢ code-review.mdc (rules)<br/>â€¢ SPEC.md (acceptance criteria)<br/>â€¢ CONSTITUTION.md (standards)"]
        S5C[AI reviews & suggests fixes]
        S5D{Gate 4<br/>Reviewer approves?}
        S5E((Done))
        
        S5A --> S5B --> S5C --> S5D
        S5D -->|No| S4A
        S5D -->|Yes| S5E
    end

    G1 --> STEP1
    L2 --> STEP1
    S1E -->|Yes| STEP2
    S2D -->|Yes| STEP3
    S3D -->|Yes| STEP4
    S4D -->|all done| STEP5

    subgraph BUGFIX["BUGFIX WORKFLOW (Separate Flow)"]
        subgraph BUGSTEP1["Bug Step 1: Create Bug Report"]
            B1A[Bug reported with reference to original SPEC.md]
            B1B["Developer prompts AI:<br/><i>'Create BUG.md for issue in @SPEC.md'</i>"]
            B1C["AI reads:<br/>â€¢ bugfixing.mdc (rules)<br/>â€¢ BUG.template.md (structure)<br/>â€¢ Original SPEC.md (context)"]
            B1D[AI generates BUG.md]
            B1E{Gate 1<br/>Tech Lead confirms?}
            
            B1A --> B1B --> B1C --> B1D --> B1E
            B1E -->|No| B1B
        end

        subgraph BUGSTEP2["Bug Step 2: Implement Fix"]
            B2A["Developer prompts AI:<br/><i>'Implement T1 from @BUG.md'</i>"]
            B2B["AI reads:<br/>â€¢ bug-implementation.mdc (rules)<br/>â€¢ BUG.md (what to fix)<br/>â€¢ Original DESIGN.md (architecture)<br/>â€¢ CONSTITUTION.md (standards)"]
            B2C[AI implements fix + regression test]
            B2D[Complete all tasks from BUG.md]
            
            B2A --> B2B --> B2C --> B2D
            B2D -->|next task| B2A
        end

        subgraph BUGSTEP3["Bug Step 3: Review Fix"]
            B3A["Developer prompts AI:<br/><i>'Review fix against @BUG.md'</i>"]
            B3B["AI reads:<br/>â€¢ bug-review.mdc (rules)<br/>â€¢ BUG.md (fix criteria)<br/>â€¢ Original SPEC.md (acceptance criteria)"]
            B3C[AI verifies fix + regression test]
            B3D{Gate 2<br/>Reviewer approves?}
            B3E[Update original SPEC.md Bug History]
            B3F((Done))
            
            B3A --> B3B --> B3C --> B3D
            B3D -->|No| B2A
            B3D -->|Yes| B3E --> B3F
        end

        B1E -->|Yes| BUGSTEP2
        B2D -->|all done| BUGSTEP3
    end

    style S0 fill:#e1f5fe,stroke:#0277bd
    style G1 fill:#e1f5fe,stroke:#0277bd
    style L1 fill:#fff9c4,stroke:#f9a825
    style L2 fill:#fff9c4,stroke:#f9a825
    style S1D fill:#fff3e0,stroke:#ef6c00
    style S2C fill:#fff3e0,stroke:#ef6c00
    style S3C fill:#fff3e0,stroke:#ef6c00
    style S4C fill:#e8f5e9,stroke:#2e7d32
    style S5C fill:#e8f5e9,stroke:#2e7d32
    style S1E fill:#ffcdd2,stroke:#c62828
    style S2D fill:#ffcdd2,stroke:#c62828
    style S3D fill:#ffcdd2,stroke:#c62828
    style S5D fill:#ffcdd2,stroke:#c62828
    style S5E fill:#c8e6c9,stroke:#2e7d32
    style S1B fill:#f3e5f5,stroke:#7b1fa2
    style S2A fill:#f3e5f5,stroke:#7b1fa2
    style S3A fill:#f3e5f5,stroke:#7b1fa2
    style S4A fill:#f3e5f5,stroke:#7b1fa2
    style S5A fill:#f3e5f5,stroke:#7b1fa2
    style S1C fill:#fce4ec,stroke:#ad1457
    style S2B fill:#fce4ec,stroke:#ad1457
    style S3B fill:#fce4ec,stroke:#ad1457
    style S4B fill:#fce4ec,stroke:#ad1457
    style S5B fill:#fce4ec,stroke:#ad1457
    style B1D fill:#fff3e0,stroke:#ef6c00
    style B2C fill:#e8f5e9,stroke:#2e7d32
    style B3C fill:#e8f5e9,stroke:#2e7d32
    style B1E fill:#ffcdd2,stroke:#c62828
    style B3D fill:#ffcdd2,stroke:#c62828
    style B3F fill:#c8e6c9,stroke:#2e7d32
    style B1B fill:#f3e5f5,stroke:#7b1fa2
    style B2A fill:#f3e5f5,stroke:#7b1fa2
    style B3A fill:#f3e5f5,stroke:#7b1fa2
    style B1C fill:#fce4ec,stroke:#ad1457
    style B2B fill:#fce4ec,stroke:#ad1457
    style B3B fill:#fce4ec,stroke:#ad1457
